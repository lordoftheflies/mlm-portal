<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="plutonium-shared-styles.html">
<link rel="import" href="plutonium-widget-behavior.html">

<dom-module id="topflavon-network-view">

    <template>

        <style include="plutonium-shared-styles">
            :host {
                display: block;
                @apply(--layout-vertical);
            }

        </style>

        <iron-ajax id="genocideIronAjax" url="[[apiUrl]]/addressbook/genocide" params="{{genocideRequestParams}}" last-response="{{parents}}"></iron-ajax>
        <iron-ajax id="possibleParentsIronAjax" url="[[apiUrl]]/addressbook/all" last-response="{{possibleParents}}" auto></iron-ajax>
        <iron-ajax id="childrenIronAjax" url="[[apiUrl]]/addressbook/children" params="{{childrenRequestParams}}" last-response="{{data}}"></iron-ajax>
        <iron-ajax id="localesAjax" url="[[apiUrl]]/localization/locales" last-response="{{locales}}" auto></iron-ajax>


        <paper-dialog id="memberDialog" modal>
            <h2 id="newMemberDialogTitle">New member</h2>
            <form id="newMemberForm" is="iron-form" class="card-content" verbose 
                  content-type="application/json" method="post" action="[[apiUrl]]/addressbook/save"
                  on-response="onCreateMemberResponse"
                  on-error="onCreateMemberError" 
                  handle-as="json">
                <paper-input id="newMemberNameLabel" name="name" label="Name" type="text"></paper-input>
                <paper-input hidden="[[isGroup(selectedType)]]" id="newMemberEmailLabel" name="email" label="Email" type="email"></paper-input>

                <input name="role" type="hidden" value="{{selectedType}}" />
                <paper-radio-group label="Type" attr-for-selected="name" selected="{{selectedType}}">
                    <paper-radio-button id="newMemberTypeUserTitle" name="USER">User</paper-radio-button>
                    <paper-radio-button id="newMemberTypeGroupTitle" name="GROUP">Group</paper-radio-button>
                    <paper-radio-button id="newMemberTypeAdminTitle" name="ADMIN">Admin</paper-radio-button>
                </paper-radio-group>

                <div>
                    <input name="parent" type="hidden" value="{{selectedParent}}" />
                    <paper-dropdown-menu id="newMemberParentLabel" label="Parent member">
                        <paper-menu
                            class="dropdown-content" selected="{{selectedParent}}" attr-for-selected="value"
                            attr-for-selected="id">
                            <template is="dom-repeat" items="{{possibleParents}}">
                                <paper-item value="{{item.id}}">{{item.name}}</paper-item>
                            </template>
                        </paper-menu>
                    </paper-dropdown-menu>
                </div>
                <div>
                    <input name="preferredLanguage" type="hidden" value="{{preferredLanguage}}" />
                    <paper-dropdown-menu id="preferredLanguageLabel" label="Preferred language">
                        <paper-menu class="dropdown-content">
                            <paper-menu class="dropdown-content" selected="{{preferredLanguage}}" attr-for-selected="data-value">
                                <template is="dom-repeat" items="[[locales]]" as="locale">
                                    <paper-item data-value="[[locale.code]]">[[locale.name]]</paper-item>
                                </template>
                            </paper-menu>
                        </paper-menu>
                    </paper-dropdown-menu>
                </div>
                <div class="card-actions">
                    <paper-button id="newMemberDialogCancelButton" dialog-dismiss>Cancel</paper-button>
                    <paper-button id="newMemberDialogCreateButton" raised class="primary" on-tap="onCreateMember" dialog-confirm>Create</paper-button>
                    <paper-button id="newMemberDialogCreateAndRepeatButton" raised class="primary" on-tap="onCreateMemberRepeat">Create & repeat</paper-button>
                </div>
            </form>
        </paper-dialog>

        <paper-dialog id="memberEraseConfirm" modal>
            <h2 id="memberEraseConfirmDialogTitle">Delete member</h2>
            <form id="deleteMemberForm" is="iron-form" 
                  verbose 
                  content-type="application/json" 
                  method="post" action="[[apiUrl]]/addressbook/delete"
                  handle-as="json">
                <div id="memberEraseConfirmDialogText" class="card-content">
                    Are you sure delete member?
                </div>
                <input name="owner" type="hidden" value="{{ownerId}}" />
                <input name="subject" type="hidden" value="{{selectedAccount}}" />
                <div class="card-actions">
                    <paper-button id="memberEraseConfirmDialogCancelButton" dialog-dismiss>Cancel</paper-button>
                    <paper-button id="memberEraseConfirmDialogAcceptButton" dialog-confirm raised on-tap="onDeleteMemberPrompted">OK</paper-button>
                </div>
            </form>
        </paper-dialog>
        <paper-dialog id="promoteAdminDialog" modal>
            <h2 id="promoteAdminDialogTitle">Promote administrator</h2>
            <form id="promoteMemberForm" is="iron-form" 
                  verbose 
                  content-type="application/json" 
                  method="post" action="[[apiUrl]]/addressbook/promote"
                  handle-as="json">
                <div id="promoteAdminDialogText" class="card-content">
                    Are you surely promote {{item.name}} to administrator?
                </div>

                <input name="owner" type="hidden" value="{{ownerId}}" />
                <input name="subject" type="hidden" value="{{selectedAccount}}" />
                <div class="card-actions">
                    <paper-button id="promoteAdminDialogCancelButton" dialog-dismiss>Cancel</paper-button>
                    <paper-button id="promoteAdminDialogAcceptButton" dialog-confirm raised on-tap="onPromoteMemberPrompted">OK</paper-button>
                </div>
            </form>
        </paper-dialog>

        <paper-dialog id="demoteAdminDialog" modal>
            <h2 id="demoteAdminDialogTitle">Demote administrator</h2>
            <form id="demoteMemberForm" is="iron-form" 
                  verbose 
                  content-type="application/json" 
                  method="post" action="[[apiUrl]]/addressbook/demote"
                  handle-as="json">
                <div id="demoteAdminDialogText" class="card-content">
                    Are you surely demote {{item.name}} to user?
                </div>
                <input name="owner" type="hidden" value="{{ownerId}}" />
                <input name="subject" type="hidden" value="{{selectedAccount}}" />
                <div class="card-actions">
                    <paper-button id="demoteAdminDialogCancelButton" dialog-dismiss>Cancel</paper-button>
                    <paper-button id="demoteAdminDialogAcceptButton" dialog-confirm raised on-tap="onDemoteMemberPrompted">OK</paper-button>
                </div>
            </form>
        </paper-dialog>

        <iron-list id="childrenIronList" items="[[data]]" as="item" hidden="[[isEmpty(data)]]" class="layout vertical">
            <template>
                <paper-item class="layout horizontal">
                    <paper-material class="flex" nodeid="[[item.id]]" on-tap="onNavigateToChildren"  tabindex="[[tabIndex]]">
                        <iron-icon class="end-justified" icon="[[getIcon(item.role)]]"></iron-icon>
                        <span >[[item.name]]</span>
                    </paper-material>
                </paper-item>
            </template>
        </iron-list>

        <paper-card elevation="1" hidden="[[!isEmpty(data)]]">
            <div class="card-content">
                <div id="emptyChildrenText">No children.</div>
            </div>
        </paper-card>

    </template>

    <script>

        Polymer({
            is: 'topflavon-network-view',
            behaviors: [
                PlutoniumBehaviors.WidgetBehavior
            ],
            properties: {
                genocideRequestParams: {
                    type: Object,
                    notify: true,
                    value: {
                        childId: null
                    }
                },
                childrenRequestParams: {
                    type: Object,
                    notify: true,
                    value: {
                        parentId: null
                    }
                },
                accountId: {
                    type: String,
                    notify: true
                },
                ownerId: {
                    type: String,
                    notify: true
                },
                selectedAccount: {
                    type: String,
                    notify: true
                },
                selectedRole: {
                    type: String,
                    notify: true
                },
                possibleParents: {
                    type: Array,
                    notify: true
                },
                locales: {
                    type: Array,
                    notify: true
                },
                unusedCodes: {
                    type: Number,
                    notify: true
                },
                selectedType: {
                    type: String,
                    notify: true,
                    value: 'USER'
                }
            },
            observers: [
                'computeChildRequestParams(selectedAccount)',
                'computeGenocideRequestParams(selectedAccount)',
                'computeSelected(accountId)'
            ],
            listeners: {
                'newMemberForm.iron-form-response': 'onCreateMemberResponse',
                'newMemberForm.iron-form-error': 'onCreateMemberError',
                'deleteMemberForm.iron-form-response': 'onDeleteMemberResponse',
                'deleteMemberForm.iron-form-error': 'onDeleteMemberError',
                'promoteMemberForm.iron-form-response': 'onPromoteMemberResponse',
                'promoteMemberForm.iron-form-error': 'onPromoteMemberError',
                'demoteMemberForm.iron-form-response': 'onDemoteMemberResponse',
                'demoteMemberForm.iron-form-error': 'onDemoteMemberError',
                'iron-select': 'onSelectMember',
                'network-tree-refresh': 'onRefresh'
            },
            ready: function () {
                console.log('Network-view is READY(account-id=' + this.accountId);
                this.selectedAccount = this.accountId;
            },
            computeChildRequestParams: function (accountId) {
                this.childrenRequestParams.parentId = accountId;
                console.log('Network-view child request parameters updated: ' + JSON.stringify(this.childrenRequestParams))
//                    this.$.childrenIronAjax.generateRequest();
                this.$.childrenIronAjax.generateRequest();
            },
            computeGenocideRequestParams: function (accountId) {
                this.genocideRequestParams.childId = accountId;
                console.log('Network-view genocide request parameters updated: ' + JSON.stringify(this.genocideRequestParams))
                this.$.genocideIronAjax.generateRequest();
            },
            computeSelected: function (accountId) {
                console.log('Change selected member from ' + this.selectedAccount + ' to ' + accountId);
                this.selectedAccount = accountId;
                this.childrenRequestParams.parentId = this.selectedAccount;
                this.genocideRequestParams.childId = this.selectedAccount;
                this.$.childrenIronAjax.generateRequest();
                this.$.genocideIronAjax.generateRequest();
            },
            onSelectMember: function (event, details) {
                console.log('Network-view select account:');
                this.unusedCodes = details.item.unusedcodes;
                this.selectedRole = details.item.role;
//                    this.$.childrenIronAjax.generateRequest();
//                    this.$.genocideIronAjax.generateRequest();
//                    
            },
            onNavigateToChildren: function (event, details) {
                this.accountId = event.currentTarget.nodeid;
                this.selectedAccount = this.accountId;

                console.log('Network-view navigate to children ');

            },
            onNavigateUp: function (event, details) {
                this.accountId = this.$.parentBeadCrumbs.children[this.$.parentBeadCrumbs.children.length < 3 ? 0 : this.$.parentBeadCrumbs.children.length - 3].nodeid;
                this.selectedAccount = this.accountId;
                this.$.childrenIronAjax.generateRequest();
                this.$.genocideIronAjax.generateRequest();
                console.log('Network-view navigate to children ');
            },
            onRefresh: function () {
                this.$.childrenIronAjax.generateRequest();
                this.$.genocideIronAjax.generateRequest();
            },
            onCreateMember: function () {
                this.$.newMemberForm.submit();
            },
            onCreateMemberRepeat: function () {
                this.$.newMemberForm.submit();
                this.$.newMemberForm.email.value = '';
                this.$.newMemberForm.role.value = 'USER';
                this.$.newMemberForm.name.value = '';
//                    this.$.newMemberForm.preferredLangiage.value = '';

//                    this.$.memberDialog.open();
            },
            onCreateMemberResponse: function (event, details) {
                console.log('Member created successfully: ' + JSON.stringify(details.response));
                this.$.childrenIronAjax.generateRequest();
                this.fire('feedback', {
                    message: 'Member created successfully'
                });
            },
            onCreateMemberError: function (event, details) {
                console.log('Create-member error: ' + JSON.stringify(details.response));
                this.fire('feedback', {
                    message: 'Member creation failed.'
                });
            },
            onDeleteMemberResponse: function (event, details) {
                console.log('Member removed successfully: ' + JSON.stringify(details.response));
                this.$.childrenIronAjax.generateRequest();
                this.fire('feedback', {
                    message: 'Member removed successfully.'
                });
            },
            onDeleteMemberError: function (event, details) {
                console.log('Remove-member error: ' + JSON.stringify(details.response));
                this.fire('feedback', {
                    message: 'Member removing failed.'
                });
            },
            onPromoteMemberResponse: function (event, details) {
                console.log('Member promoted successfully: ' + JSON.stringify(details.response));
                this.$.childrenIronAjax.generateRequest();
                this.fire('feedback', {
                    message: 'Member promoted successfully'
                });
            },
            onPromoteMemberError: function (event, details) {
                console.log('Promote-member error: ' + JSON.stringify(details.response));
                this.fire('feedback', {
                    message: 'Member promoting failed.'
                });
            },
            onDemoteMemberResponse: function (event, details) {
                console.log('Member demoted successfully: ' + JSON.stringify(details.response));
                this.$.childrenIronAjax.generateRequest();
                this.fire('feedback', {
                    message: 'Member demoted successfully'
                });
            },
            onDemoteMemberError: function (event, details) {
                console.log('Demote-member error: ' + JSON.stringify(details.response));
                this.fire('feedback', {
                    message: 'Member demoting failed.'
                });
            },
            isEmpty: function (data) {
                return data === undefined || data === null || data.length === 0;
            },
            isGroup: function (data) {
                return data === 'GROUP';
            },
            isAdmin: function (data) {
                return data === 'ADMIN';
            },
            isUser: function (data) {
                return data === 'USER';
            },
            getIcon: function (data) {
                if (data === 'GROUP') {
                    return 'supervisor-account';
                } else if (data === 'USER') {
                    return 'star-border';
                } else if (data === 'ADMIN') {
                    return 'star';
                }
            },
//            getOwnerAccount: function () {
//                if (app.sessionInfo)
//                    return app.sessionInfo.token;
//                else
//                    return null;
//            },
            onDemoteMemberPrompted: function () {
                this.$.demoteMemberForm.submit();
                console.log('Demote member prompted.');
            },
            onDeleteMemberPrompted: function () {
                this.$.deleteMemberForm.submit();
                console.log('Delete member prompted.');
            },
            onPromoteMemberPrompted: function () {
                this.$.promoteMemberForm.submit();
                console.log('Promote member prompted.');
            }
        });

    </script>

</dom-module>