<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="topflavon-shared-styles.html">
<link rel="import" href="plutonium-widget-behavior.html">

<dom-module id="topflavon-share-view">

    <template>

        <style include="topflavon-shared-styles">

        </style>

        <iron-ajax 
            id="contactsAjax"
            url="{{apiUrl}}/addressbook/{{accountId}}/contacts" 
            last-response="{{contacts}}" 
            auto>
        </iron-ajax>
        <iron-ajax 
            id="parentCandidatesAjax"
            url="{{apiUrl}}/content-management/candidates/parent" 
            last-response="{{parentCandidates}}" 
            auto>
        </iron-ajax>

        <iron-ajax 
            id="shareAjax"
            handle-as="json"
            content-type="application/json"
            method="POST"
            url="{{apiUrl}}/content-management/save" 
            body="{{pageDto}}"></iron-ajax>

        <iron-pages selected="{{selectedMetaAction}}" attr-for-selected="name">
            <paper-card elevation="1" name="share" class="layout vertical">
                <div class="card-content layout horizontal">
                    <div class="flex layout vertical">
                        <plutonium-field-recipient  
                            class="flex"
                            id="recipientsFieldInput"
                            label="To"
                            picker-icon="supervisor-account"
                            picker-title="Contacts"
                            picker-button-tooltip="Choose contacts."
                            clear-icon="clear"
                            clear-button-tooltip="Clear recipients input."
                            attr-for-selected="id"
                            as="item"
                            items="[[contacts]]">
                            <template is="dom-repeat" items="[[contacts]]">
                                <paper-item id="[[item.id]]" class="item pad">
                                    <label>[[item.name]]</label>
                                </paper-item>
                            </template>
                        </plutonium-field-recipient>
                        <paper-input id="messageInput" class="bottom title" label="Message" value="{{message}}"></paper-input>
                    </div>
                    <!--<div></div>-->
                    <paper-fab class="end-justified" icon="send" on-tap="onSend" title="Publish content" id="sendMessageFab"></paper-fab>
                </div>

            </paper-card>


            <paper-card elevation="1" name="assembled" class="layout vertical">
                <div class="card-content layout horizontal" style="padding-top: 10px;">
                    <plutonium-article-form  
                        class="flex"
                        api-url="{{apiUrl}}"
                        id="pcf"
                        editable
                        contacts="{{contacts}}" 
                        content-model="{{contentModel}}"
                        parent-candidates="{{parentCandidates}}"
                        editors="[[editorMap]]">
                    </plutonium-article-form>
                </div>
            </paper-card>

            <paper-card elevation="1" name="embedded" class="layout vertical">
                <div class="card-content layout horizontal">
                    <file-upload 
                        id="uploadFileText"
                        drop-text="Drop any PDF file here."
                        error-text="File upload failed."
                        droppable="true" 
                        raised="true" 
                        multi="false" 
                        method="POST"
                        target="{{fileUploadTarget}}">Choose File</file-upload>
                    <div class="flex"></div>
                    <paper-fab class="end-justified" icon="send" on-tap="onSend" title="Publish content" id="sendMessageFab"></paper-fab>
                </div>
            </paper-card>

            <paper-card elevation="1"  name="props" class="layout vertical">
                <div class="card-content layout horizontal">
                    <div class="layout vertical flex">
                        <paper-dropdown-menu 
                            id="parentDdLabel"
                            label="Parent">
                            <paper-listbox id="parentCandidatesList"
                                           class="dropdown-content"
                                           attr-for-selected="{{attrForSelected}}"
                                           items="[[parentCandidates]]"
                                           as="parent"
                                           selected="{{selectedParent}}">
                                <template is="dom-repeat" items="[[parentCandidates]]">

                                    <paper-item id="[[item.id]]" class="item pad">
                                        <label>[[item.title]]</label> 
                                    </paper-item>
                                </template>
                            </paper-listbox>
                        </paper-dropdown-menu>

                        <paper-input id="contentTitleInput" class="bottom title" label="Title" value="{{contentModel.title}}"></paper-input>
                    </div>
                    <paper-fab class="end-justified" icon="send" on-tap="onSend" title="Publish content" id="sendMessageFab"></paper-fab>

                </div>
            </paper-card>

        </iron-pages>

    </template>

    <script>

        Polymer({
            is: 'topflavon-share-view',
            behaviors: [
                PlutoniumBehaviors.WidgetBehavior
            ],
            properties: {
                shareAjaxRequest: {
                },
                pageDto: {
                    type: Object,
                    notify: true
                },
                contentModel: {
                    type: Object,
                    notify: true,
                    value: {
                        sections: [
                        ]
                    }
                },
                selectedMetaAction: {
                    type: String,
                    notify: true,
                    value: 'assembled'
                }
            },
            observers: [
//                'updateModel(sections)'
            ],
            listeners: {
                'share': 'onShare',
                'shareAjax.error': 'onShareError',
                'shareAjax.response': 'onShareResponse'
            },
            ready: function () {
                console.log(this.is + ' is ready.');
            },
//            updateModel: function (sections) {
//                this.pageDto = {
//                };
//            },
            onShare: function (e, details) {
                console.log('Save content: ' + JSON.stringify(details));
                this.pageDto = details.content;
                this.$.shareAjax.generateRequest();
            },
            onShareError: function () {
                this.fire('feedback', {
                    message: 'Content sharing failed.'
                });
            },
            onShareResponse: function () {
                this.fire('feedback', {
                    message: 'New content shared successfully.'
                });
            }
        });

    </script>

</dom-module>