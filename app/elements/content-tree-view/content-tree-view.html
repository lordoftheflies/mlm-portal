<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/grapp-breadcrumbs/grapp-breadcrumbs.html">

<link rel="import" href="../../bower_components/i18n-behavior/i18n-behavior.html">

<dom-module id="content-tree-view">
    <template>
        <style include="shared-styles iron-flex iron-flex-alignment">
            :host {
                display: block;
                /*                @apply(--layout-vertical);
                                @apply(--layout-flex);*/
            }


            iframe {
                @apply(--layout-vertical);
                @apply(--layout-flex);
                margin-top: 16px;
                width: 100%;
                height: 500px;
            }
            /*content-viewer {*/
            /*                width: 100%;
                            @apply(--layout-vertical);
                            @apply(--layout-flex);*/
            /*}*/
        </style>
        <paper-material class="layout horizontal">

            <paper-tabs selected="{{selectedRoot}}" scrollable attr-for-selected="id" class="flex">
                <template is="dom-repeat" items="{{parentModel.sections}}">
                    <paper-tab id="[[item.name]]" href="{{baseUrl}}content-tree/{{item.data}}">
                        <a href="{{baseUrl}}content-tree/{{item.data}}">[[item.title]]</a>
                    </paper-tab>
                </template>
            </paper-tabs>
            <div hidden="{{!isDraftSelected(selectedContentFolder)}}">
                <paper-icon-button icon="create" on-tap="onEditArticle"></paper-icon-button>
                <paper-icon-button icon="delete"></paper-icon-button>
                <paper-icon-button icon="file-upload"></paper-icon-button>
                <paper-icon-button icon="file-download"></paper-icon-button>
            </div>
        </paper-material>


        <div class="content-tree-content">
            <template is="dom-if" if="{{data.hasEmbeddedFile}}">
                <iframe src$="{{getContentFileUrl(data.embeddedFileName)}}"></iframe>
            </template>

            <template is="dom-if" if="{{!isEmpty(data.sections)}}">
                <div class="layout vertical flex">
                    <iron-list items="{{data.sections}}" as="section" hidden="[[data.leaf]]">
                        <template>
                            <div>
                                <paper-material elevation="1" 
                                                href="{{section.name}}" 
                                                on-tap="onNavigate" 
                                                hidden="[[!section.hasEmbeddedFile]]" 
                                                id="articleTitleLabel" 
                                                class="item"
                                                title="Navigate to {{baseUrl}}content-tree/{{section.data}}">
                                    <span>[[section.title]]</span>
                                </paper-material>

                                <paper-material elevation="1"
                                                href="{{section.data}}" 
                                                on-tap="onNavigate" 
                                                hidden="[[section.hasEmbeddedFile]]" 
                                                id="articleTitleLabel"
                                                class="item"
                                                title="Navigate to {{baseUrl}}content-tree/{{section.data}}">
                                    <span>[[section.title]]</span>
                                </paper-material>
                            </div>
                        </template>
                    </iron-list>

                    <br />
                    <paper-card heading="{{data.title}}" hidden="{{!data.leaf}}">
                        <plutonium-article-section 
                            class="card-content layout vertical"
                                           content-model="{{data}}">
                        </plutonium-article-section>
                    </paper-card>
                </div>

            </template>

        </div>
        <div  hidden="{{!isEmpty(data)}}" class="folder-content">
            <br />
            <paper-card elevation="1">
                <div class="card-content">
                    <div id="emptyContentFolderText">No content in the folder.</div>
                </div>
            </paper-card>
        </div>

    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'content-tree-view',
                behaviors: [
                    PlutoniumBehaviors.WidgetBehavior,
                    BehaviorsStore.I18nBehavior
                ],
                properties: {
                    tocRequestParams: {
                        type: Object,
                        notify: true,
                        value: {
                            pageId: 'ROOT'
                        }
                    },
                    infoRequestParams: {
                        type: Object,
                        notify: true,
                        value: {
                            pageId: 'ROOT'
                        }
                    },
                    renderBreadCrumbs: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    selectedContentFolder: {
                        type: String,
                        notify: true,
                        value: 'public',
                        observer: 'observeSelectedContentFolder'
                    },
                    selectedRoot: {
                        type: String,
                        notify: true
                    },
                    baseUrl: {
                        type: String,
                        notify: true
                    },
                    rootModel: {
                        type: Object,
                        notify: true
                    },
                    parentModel: {
                        type: Object,
                        notify: true
                    },
                    data: {
                        type: Object,
                        notify: true
                    },
                    contentRootUrl: {
                        type: String,
                        notify: true,
                        value: 'http://localhost/topn_data/'
                    }
                },
                observers: [
                    'computeTocRequestParams(selectedRoot, selectedContentFolder)',
//                    'computeTitle(data.title)'
                ],
                ready: function () {
                    console.log('Toc-Content-view is READY(account-id=' + this.selectedRoot + ')');
                },
                computeTocRequestParams: function (selectedRoot, selectedContentFolder) {
                    this.tocRequestParams.pageId = selectedRoot;
                    this.tocRequestParams.tag = selectedContentFolder;
                    this.infoRequestParams.pageId = selectedRoot;
                    console.log('Toc-Content-view toc navigation request parameters updated: ' + JSON.stringify(this.tocRequestParams))
                    if (this.data !== undefined)
                        this.splice('data.sections', 0, this.data.sections.length);
                    app.$.rootModelAjax.generateRequest();
                    app.$.childTocAjax.generateRequest();
                    app.$.parentTocAjax.generateRequest();
                },
                observeSelectedContentFolder: function (folder) {
                    this.tocRequestParams.tag = folder;
                    app.$.rootModelAjax.generateRequest();
                    app.$.childTocAjax.generateRequest();
                    app.$.parentTocAjax.generateRequest();
                },
                getItemClasses: function (item) {
                    return item.tags.join(" ");
                },
                isLeaf: function (item) {
                    console.log(item.sections.length);
                    return item.sections.length === 0;
                },
                isFork: function (item) {
                    return item.sections.length > 0;
                },
                isEmpty: function (data) {
                    return (data === undefined || data === null || data.length === 0);
                },
                getContentFileUrl: function (fileName) {
                    return this.contentRootUrl + fileName;
                },
                isDraftSelected: function (selectedContentFolder) {
                    console.log('Fasz');
                    return selectedContentFolder === 'drafts';
                },
                onEditArticle: function () {
                    page.redirect(app.baseUrl + 'share-content')
                    app.currentEditedContent = this.data;
                },
//                computeTitle: function (data) {
//                    this.title = data.title;
//                },
                onNavigate: function (event, details) {
                    page.redirect(app.baseUrl + 'content-tree/' + details.sourceEvent.currentTarget.href);
                }
            });
        })();
    </script>
</dom-module>
